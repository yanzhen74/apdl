# POEM_协议编排与扩展模块设计

## 1. 模块概述

POEM（Protocol Orchestration and Extension Module）是APDL框架的核心组件之一，负责协议的编排、扩展和管理。该模块提供了灵活的协议定义、字段映射、序列控制等功能。

## 2. 核心功能

### 2.1 FrameAssembler - 协议帧组装器

FrameAssembler 是 POEM 模块的核心组件，负责协议帧的组装和解析。

#### 2.1.1 字节序管理

- **内部统一存储**：所有数据在内部统一使用大端字节序（Big Endian）进行存储和处理
- **外部字节序适配**：支持字段级别的字节序配置，可在输出到字段或从字段读取时自动进行字节序转换
- **字段字节序映射**：通过 `field_byte_orders` HashMap 管理每个字段的字节序配置
- **默认字节序**：未指定字节序的字段默认使用大端字节序

#### 2.1.2 字段值管理

- **字段值存储**：通过 `field_values` HashMap 存储字段的实际字节值
- **字节序转换**：在设置和获取字段值时自动进行字节序转换
- **内部转换函数**：
  - `convert_field_value_for_storage()`：将外部字节序转换为内部大端字节序存储
  - `convert_field_value_from_storage()`：将内部大端字节序转换为外部字节序输出

### 2.2 序列控制规则处理器

sequence_control_rule_handler.rs 提供了序列号管理和控制功能。

#### 2.2.1 序列号递增逻辑

- **内部操作**：序列号递增操作在内部统一的大端字节序上进行
- **直接存储访问**：避免了双重字节序转换问题，直接操作内部存储
- **字节序无关**：确保序列号递增逻辑不受外部字段字节序配置影响

## 3. 数据结构

### 3.1 ByteOrder 枚举

定义了支持的字节序类型：
- `BigEndian`：大端字节序
- `LittleEndian`：小端字节序

### 3.2 FrameAssembler 结构

扩展了原有结构，增加了字节序管理功能：
- `field_byte_orders`：字段字节序映射表

## 4. 工具函数

### 4.1 字节序转换函数

- `bytes_to_u64_be()`：大端字节序转换为 u64
- `bytes_to_u64_le()`：小端字节序转换为 u64
- `u64_to_bytes_be()`：u64 转换为大端字节序
- `u64_to_bytes_le()`：u64 转换为小端字节序

## 5. 接口设计

### 5.1 字节序管理接口

- `set_field_byte_order()`：设置字段字节序
- `get_field_byte_order()`：获取字段字节序

## 6. 设计原则

- **统一性**：内部统一使用大端字节序，简化内部处理逻辑
- **透明性**：对外提供透明的字节序转换，用户无需关心内部实现
- **兼容性**：保持与现有功能的向后兼容
- **可扩展性**：支持未来添加更多字节序类型