# APDL 分层与连接器 DSL 开发计划（基于当前实现现状）

## 项目概述

基于当前已有的DSL基础（基础字段定义、23种语义规则、字段映射功能），开发新的分层与连接器 DSL 层，实现多层协议结构描述和层间连接器定义功能。

## 现状分析

### 已有功能
- 基础DSL语法：field, type, length, scope, cover等
- 23种语义规则：checksum, dependency, conditional, order, pointer等
- 字段映射规则：field_mapping（基础实现）
- 模块化解析器架构：dsl_parser, semantic_rule_parsers等

### 待实现功能
- 包定义语法：package语法支持
- 连接器定义：connector语法支持  
- 协议栈定义：protocol_stack语法支持
- 导头指针处理：header pointer相关规则
- 多层协议栈：层间关系定义

## 开发目标

1. 扩展现有DSL语法，增加package定义能力
2. 实现连接器DSL语法，支持包间映射
3. 实现协议栈DSL语法，支持多层协议定义
4. 扩展语义规则，支持导头指针处理
5. 与现有系统无缝集成

## 详细开发计划

### Phase 1: 扩展现有数据结构 (预计 3 天)

#### Day 1: 扩展 apdl_core 数据结构
- [ ] 扩展 `SemanticRule` 枚举，添加 `PackageDefinition`、`ConnectorDefinition`
- [ ] 扩展 `SyntaxUnit` 结构支持包定义
- [ ] 添加 `PackageDefinition` 结构
- [ ] 添加 `ConnectorDefinition` 结构
- [ ] 添加 `ProtocolStackDefinition` 结构

#### Day 2: 扩展解析器接口
- [ ] 扩展 `DslParser` trait 支持新语法
- [ ] 扩展 `LengthUnit` 和 `UnitType` 支持新类型
- [ ] 添加 `NestedPacketDescriptor` 相关结构
- [ ] 添加指针处理相关规则结构

#### Day 3: 单元测试
- [ ] 为新数据结构编写单元测试
- [ ] 验证与现有结构的兼容性
- [ ] 修复发现的问题

### Phase 2: 扩展解析器 (预计 7 天)

#### Day 4-5: 扩展现有解析器
- [ ] 扩展 `dsl_parser.rs` 支持 package 语法
- [ ] 扩展 `dsl_parser.rs` 支持 connector 语法
- [ ] 扩展 `dsl_parser.rs` 支持 protocol_stack 语法
- [ ] 实现语法识别和分派逻辑
- [ ] 扩展解析器单元测试

#### Day 6-7: 新增包解析器
- [ ] 创建 `package_parser.rs`
- [ ] 实现 `parse_package_definition()` 函数
- [ ] 实现包定义验证逻辑
- [ ] 实现包依赖解析
- [ ] 包解析器单元测试

#### Day 8-9: 新增连接器解析器
- [ ] 创建 `connector_parser.rs`
- [ ] 实现 `parse_connector_definition()` 函数
- [ ] 实现连接器映射解析
- [ ] 实现连接器配置解析
- [ ] 连接器解析器单元测试

#### Day 10: 新增协议栈解析器
- [ ] 创建 `protocol_stack_parser.rs`
- [ ] 实现 `parse_protocol_stack()` 函数
- [ ] 实现协议栈验证逻辑
- [ ] 实现并列包组解析
- [ ] 协议栈解析器单元测试

### Phase 3: 语义规则扩展 (预计 5 天)

#### Day 11-12: 导头指针规则扩展
- [ ] 扩展 `semantic_rule_parsers` 支持指针解析规则
- [ ] 实现 `pointer_resolution` 规则解析
- [ ] 实现 `boundary_detection` 规则解析
- [ ] 实现 `stream_injection` 规则解析
- [ ] 指针规则单元测试

#### Day 13-14: 扩展字段映射规则
- [ ] 扩展 `field_mapping_parser.rs` 支持复杂映射
- [ ] 实现嵌套结构映射解析
- [ ] 实现算法映射解析
- [ ] 实现默认值处理
- [ ] 字段映射增强单元测试

#### Day 15: 规则集成测试
- [ ] 实现语义规则综合测试
- [ ] 验证规则间的协同工作
- [ ] 修复规则冲突问题

### Phase 4: 处理器实现 (预计 8 天)

#### Day 16-17: 包处理器实现
- [ ] 实现 `PackageProcessor` 结构
- [ ] 实现包初始化逻辑
- [ ] 实现包验证逻辑
- [ ] 实现包依赖处理
- [ ] 包处理器单元测试

#### Day 18-19: 连接器处理器实现
- [ ] 实现 `ConnectorProcessor` 结构
- [ ] 实现字段映射处理逻辑
- [ ] 实现算法映射处理逻辑
- [ ] 实现数据流转处理逻辑
- [ ] 连接器处理器单元测试

#### Day 20-21: 指针处理器实现
- [ ] 实现 `HeaderPointerProcessor` 结构
- [ ] 实现主导头指针解析
- [ ] 实现副导头指针解析
- [ ] 实现数据区子包恢复
- [ ] 指针处理器单元测试

#### Day 22-23: 协议栈处理器实现
- [ ] 实现 `ProtocolStackProcessor` 结构
- [ ] 实现多层处理链
- [ ] 实现层间通信机制
- [ ] 实现并列包处理
- [ ] 协议栈处理器单元测试

### Phase 5: 集成与测试 (预计 7 天)

#### Day 24-25: 系统集成
- [ ] 集成所有新功能模块
- [ ] 实现向后兼容性保证
- [ ] 实现错误处理机制
- [ ] 集成测试

#### Day 26-27: 端到端测试
- [ ] 实现完整的CCSDS协议栈测试
- [ ] 实现遥测包到封装包映射测试
- [ ] 实现导头指针处理测试
- [ ] 性能基准测试

#### Day 28-29: 兼容性与回归测试
- [ ] 确保现有功能不受影响
- [ ] 运行所有现有测试用例
- [ ] 修复集成中发现的问题

### Phase 6: 示例与文档 (预计 3 天)

#### Day 30-31: 示例开发
- [ ] 开发基础包定义示例
- [ ] 开发连接器使用示例
- [ ] 开发协议栈定义示例
- [ ] 开发完整CCSDS协议栈示例

#### Day 32: 文档更新
- [ ] 更新用户指南
- [ ] 更新API文档
- [ ] 更新架构文档

## 与现有系统的集成策略

### 1. 渐进式集成
- 保持现有DSL语法不变
- 逐步添加新语法支持
- 确保向后兼容性

### 2. 模块化扩展
- 利用现有解析器架构
- 遵循现有代码风格
- 保持模块间松耦合

### 3. 测试驱动
- 为每个新功能编写测试
- 确保现有测试继续通过
- 实现全面的回归测试

## 预期成果

1. ✅ 完整的分层与连接器 DSL 语法
2. ✅ 与现有系统兼容的解析器
3. ✅ 高效的处理器实现
4. ✅ 全面的测试覆盖
5. ✅ 详细的示例和文档

## 风险评估与缓解

1. **兼容性风险**：新功能可能影响现有功能
   - 缓解措施：严格的回归测试，渐进式集成

2. **性能风险**：新增功能可能影响解析性能
   - 缓解措施：性能基准测试，优化关键路径

3. **复杂性风险**：语法扩展可能引入复杂性
   - 缓解措施：模块化设计，清晰的接口定义

## 成功标准

1. DSL语法能够正确定义复杂的多层协议结构
2. 解析器能够正确解析所有新语法结构
3. 处理器能够正确执行层间数据流转
4. 所有测试用例通过率100%
5. 性能指标满足系统要求
6. 与现有系统完全兼容
7. 成功实现《数据区子包恢复_DSL设计.md》中的所有功能