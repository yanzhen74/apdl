{
  "name": "ccsds_packet_structure",
  "description": "CCSDS 空间数据包结构定义 - 符合 CCSDS 133.0-B-2 标准",
  "version": "1.0.0",
  "type": "packet",
  "fields": [
    {
      "name": "pkt_type",
      "type": "Uint8",
      "length": "1byte",
      "scope": "layer(transport)",
      "cover": "entire_field",
      "constraint": "range(0..=1)",
      "description": "包类型(0=遥测包,1=遥控包)",
      "offset": 0
    },
    {
      "name": "sec_hdr_flag",
      "type": "Uint8",
      "length": "1byte",
      "scope": "layer(transport)",
      "cover": "entire_field",
      "constraint": "range(0..=1)",
      "description": "二级头标志(0=不存在,1=存在)",
      "offset": 1
    },
    {
      "name": "apid",
      "type": "Uint16",
      "length": "2byte",
      "scope": "layer(transport)",
      "cover": "entire_field",
      "constraint": "range(0..=2047)",
      "description": "应用进程标识符(APID)",
      "offset": 2
    },
    {
      "name": "seq_flags",
      "type": "Uint8",
      "length": "1byte",
      "scope": "layer(transport)",
      "cover": "entire_field",
      "constraint": "range(0..=3)",
      "description": "序列标志(0=继续,1=第一,2=最后,3=独立)",
      "offset": 4
    },
    {
      "name": "pkt_seq_cnt",
      "type": "Uint16",
      "length": "2byte",
      "scope": "layer(transport)",
      "cover": "entire_field",
      "constraint": "range(0..=16383)",
      "description": "包序列计数(0-16383循环)",
      "offset": 5
    },
    {
      "name": "pkt_len",
      "type": "Uint16",
      "length": "2byte",
      "scope": "layer(transport)",
      "cover": "entire_field",
      "constraint": "range(0..=65535)",
      "description": "包数据长度-1(字节数)",
      "offset": 7
    },
    {
      "name": "pkt_data",
      "type": "RawData",
      "length": "dynamic",
      "scope": "layer(application)",
      "cover": "entire_field",
      "description": "包数据字段(可变长度)",
      "offset": 9
    },
    {
      "name": "pkt_ecf",
      "type": "Uint16",
      "length": "2byte",
      "scope": "layer(transport)",
      "cover": "entire_field",
      "algorithm": "crc16",
      "description": "包错误检测字段(可选CRC-16)",
      "optional": true
    }
  ],
  "rules": [
    {
      "type": "dependency",
      "description": "pkt_len字段依赖于pkt_data的实际长度",
      "source_field": "pkt_len",
      "target_field": "pkt_data",
      "logic": "pkt_len = length(pkt_data) - 1"
    },
    {
      "type": "sequence_control",
      "description": "包序列计数器应递增并循环",
      "field": "pkt_seq_cnt",
      "logic": "monotonic_increase",
      "modulo": 16384
    },
    {
      "type": "constraint_validation",
      "description": "验证APID的有效范围",
      "field": "apid",
      "constraint": "0 <= apid <= 2047",
      "reserved_values": [2047]
    },
    {
      "type": "checksum_validation",
      "description": "如果存在pkt_ecf，需要对整个包进行CRC-16校验",
      "field": "pkt_ecf",
      "algorithm": "crc16_ccitt",
      "range": {
        "start": "pkt_type",
        "end": "pkt_data"
      },
      "conditional": "sec_hdr_flag == 1"
    },
    {
      "type": "boundary_detection",
      "description": "根据pkt_len确定包边界",
      "length_field": "pkt_len",
      "data_field": "pkt_data",
      "calculation": "pkt_len + 1"
    },
    {
      "type": "field_mapping",
      "description": "包类型到处理流程的映射",
      "source_field": "pkt_type",
      "mappings": [
        {"value": 0, "target": "telemetry_handler"},
        {"value": 1, "target": "telecommand_handler"}
      ]
    },
    {
      "type": "enum_mapping",
      "description": "序列标志的枚举映射",
      "field": "seq_flags",
      "mappings": [
        {"value": 0, "name": "continuation", "description": "继续分段"},
        {"value": 1, "name": "first", "description": "第一个分段"},
        {"value": 2, "name": "last", "description": "最后一个分段"},
        {"value": 3, "name": "unsegmented", "description": "未分段(完整包)"}
      ]
    }
  ],
  "metadata": {
    "standard": "CCSDS 133.0-B-2",
    "category": "space_packet_protocol",
    "layer": "transport",
    "typical_size": "variable (min: 7 bytes header + data)",
    "usage": "航天器间数据包传输"
  }
}
