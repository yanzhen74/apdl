# APDL 连接器系统架构说明

## 概述

APDL连接器系统由两个主要组件构成，它们在不同阶段协同工作，共同实现协议层间的连接和数据传输。连接器不仅负责字段映射，还负责数据放置策略。

## 架构组件

### 1. DSL解析层 (`src/dsl/layers/connector_parser.rs`)

**职责**：
- 解析文本格式的连接器DSL定义
- 验证DSL语法的正确性
- 将DSL转换为内部数据结构

**执行时机**：
- 编译时或初始化时
- 一次性的配置加载过程

**输入**：
- DSL文本定义

**输出**：
- `ConnectorDefinition` 数据结构

**关键功能**：
- 语法解析
- 结构验证
- 配置构建

### 2. 运行时引擎层 (`src/standard_units/connector/connector_engine.rs`)

**职责**：
- 在运行时执行已解析的映射规则
- 实际进行字段值的转换和传输
- 处理数据放置策略
- 处理数据流的实际映射

**执行时机**：
- 协议处理运行时
- 针对每个数据包的实时处理

**输入**：
- 源数据包
- 目标数据包
- 已解析的映射规则和数据放置策略

**输出**：
- 映射后的目标数据包

**关键功能**：
- 规则执行
- 数据转换
- 数据放置策略执行
- 运行时处理

## 连接器功能分类

### 1. 字段映射功能
- **功能**：将源包字段值映射到目标包字段
- **实现**：通过字段映射规则（Field Mapping Rules）
- **类型**：identity, hash_mod_64, hash_mod_2048等

### 2. 数据放置策略
- **功能**：决定如何将子包数据放入父包的数据区
- **策略类型**：
  - **导头指针方式**：通过指针指向子包位置
  - **直接放入方式**：当长度固定且匹配时直接嵌入
  - **数据流方式**：按流数据放入固定长度的数据区
  - **其他策略**：可根据协议需求扩展

## 协作流程

```
DSL文本定义
      ↓ (解析)
ConnectorParser
      ↓ (生成)
ConnectorDefinition
      ↓ (配置)
ConnectorEngine
      ↓ (运行时执行)
数据包转换 + 数据放置
```

## 设计优势

1. **关注点分离**：
   - 解析逻辑与执行逻辑分离
   - 配置定义与运行时处理分离
   - 字段映射与数据放置策略分离

2. **性能优化**：
   - 解析仅在初始化时发生
   - 运行时只需执行预解析的规则

3. **灵活性**：
   - 支持动态配置
   - 可扩展的映射规则和数据放置策略

## 使用场景

### DSL解析层
- 系统启动时加载连接器配置
- 验证DSL定义的正确性
- 构建运行时所需的配置对象

### 运行时引擎层
- 协议栈运行时的数据包处理
- 实时的字段映射转换
- 多协议层之间的数据传输
- 根据策略放置数据到目标位置

## 集成要点

1. `ConnectorParser` 生成的 `ConnectorDefinition` 可直接被 `ConnectorEngine` 使用
2. 两个组件共享 `apdl_core` 中定义的数据结构
3. 解析层的配置结果作为运行时引擎的输入

## 维护建议

- 修改DSL语法时，只需更新解析层
- 添加新的映射逻辑时，可在运行时引擎中扩展
- 添加新的数据放置策略时，同样在运行时引擎中扩展
- 两层之间的接口通过 `apdl_core` 中的公共结构定义