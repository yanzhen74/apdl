# CCSDS语法单元研究笔记

## 1. 研究背景

在APDL（APDS协议定义语言）项目中，我们需要深入理解CCSDS协议的语法单元，以确保项目需求的合理性和技术实现的可行性。通过研究CCSDS协议标准文档和相关资料，我们对协议结构和语法单元有了更深入的认识。

## 2. CCSDS协议核心概念

### 2.1 协议层次结构
CCSDS协议采用分层架构，主要包含：
- 物理层：信号传输
- 数据链路层：TM/TC协议
- 网络层：AOS协议
- 传输层：CFDP协议
- 应用层：任务特定协议

### 2.2 语法单元定义
语法单元是协议的基本构成元素，每个单元负责特定的协议功能，具有明确的输入输出接口。

## 3. DSL规范与JSON协议描述

### 3.1 语法单元DSL通用规范
- **基础结构**：field、type、length、scope、cover等必选字段
- **可选字段**：constraint、alg、associate、desc、role等
- **数据类型**：UintN、Bit(N)、RawData、Ip6Addr等
- **作用范围**：layer、cross_layer、global等
- **数据覆盖**：frame_header[0..1]、$cover等

### 3.2 CCSDS分包遥测协议JSON描述
- **协议元数据**：协议ID、名称、版本等
- **语法单元列表**：字段定义和DSL描述
- **帧结构**：帧头、数据区、帧尾描述
- **打包/拆包规范**：操作步骤和细节
- **帧流嵌套结构**：支持嵌套的子包结构

## 4. Rust开发适配与模块接口

### 4.1 核心模块接口定义
- **DSL解析器接口**：DslParser Trait，支持DSL解析和验证
- **协议组装平台接口**：ProtocolAssembler Trait，支持语法单元添加和协议规范生成
- **语法单元结构**：SyntaxUnit，包含字段定义和属性
- **协议层结构**：ProtocolLayer，定义协议层和单元关系

### 4.2 Rust依赖库选择
- **DSL解析**：nom库，用于高效解析DSL语法
- **多格式文档解析**：docx-rs、calamine、pdf-rs，解析各种文档格式
- **CRC计算**：crc库，实现CCSDS和CAN标准算法
- **异步链路仿真**：tokio和bytes，高并发处理
- **自定义脚本执行**：rhai，安全执行用户逻辑
- **错误处理**：anyhow和thiserror，统一错误类型

## 5. 核心语法单元分析

### 5.1 帧结构基础单元（控制帧/数据帧通用骨架）
- **LLC帧同步序列单元**：帧边界检测，固定值0xEB90
- **LLC帧类型标识单元**：区分数据帧与控制帧（1比特）
- **LLC帧长度字段单元**：标识帧的实际长度（16比特）

### 5.2 信道与地址单元（数据路由定位）
- **虚拟信道标识单元**：标识数据传输的虚拟信道（6比特）
- **目标地址单元**：指定数据包的目标地址（32比特）

### 5.3 数据完整性单元（错误检测/重传）
- **CRC-16校验单元**：检测数据传输错误（16比特）
- **帧序号单元**：检测丢帧情况（8比特）

### 5.4 数据控制单元（分段/复接逻辑）
- **分段标识单元**：标识数据包的分段类型（2比特）
- **数据长度指示单元**：定位数据边界（16比特）

### 5.5 用户自定义扩展单元（协议扩展）
- **设备状态码单元**：扩展设备状态信息（8比特）
- **自定义时间戳单元**：添加时间标记（32比特）

## 6. 帧结构关键单元深化分析

### 6.1 帧数据区嵌套单元（导头指针）
- **主导头指针单元**：定位帧数据区的首个子包（16比特）
- **副导头指针单元**：定位帧数据区的后续子包（16比特）
- **子包数据区关联机制**：实现子包数据区的关联管理

### 6.2 帧序列管理单元（标志+序列号）
- **帧序列标志单元**：区分帧角色（单帧/首帧/中间帧/尾帧）（2比特）
- **帧序列号单元**：顺序追踪（8比特）
- **丢帧检测和重复过滤机制**：实现丢帧检测和重复过滤

### 6.3 分路单元（数据分发）
- **基础分路标识单元**：提供基础分路依据（6比特）
- **扩展分路标识单元**：提供精细化分路（8比特）
- **数据分发机制**：实现数据分发功能

## 7. CAN总线协议语法单元扩展

### 7.1 总线仲裁类单元
- **CAN仲裁场单元**：总线仲裁，确定消息优先级（11/29位ID，RTR位标识数据帧/远程帧）
- **CAN仲裁退避单元**：仲裁失败后等待总线空闲并重新发送（8比特，0-10次）

### 7.2 帧控制与错误处理类单元
- **DLC字段单元**：数据长度码，标识数据字段长度（4比特，0-15）
- **位填充单元**：连续5个相同位后插入相反位，用于接收端同步（1比特）
- **ACK应答单元**：接收端确认机制（2比特，ACK位+界定符）

## 8. 语法单元作用范围分类

### 8.1 层内局部单元（单一层+部分字段）
- 作用于单一层内的局部范围
- 覆盖单一层内的部分字段
- 示例：帧序号（作用于当前帧）

### 8.2 层内全量单元（单一层+全量数据）
- 作用于单一层内的全量数据
- 覆盖单一层的完整数据（可能排除自身）
- 示例：链路层CRC-16（覆盖帧控制到用户数据，不含自身）

### 8.3 跨层穿透单元（相邻层+层间数据）
- 作用于相邻层之间的数据传递
- 覆盖跨层的数据范围
- 示例：SDU长度指示（从应用层到网络层）

### 8.4 全链路全局单元（全链路+端到端数据）
- 作用于全链路的端到端数据
- 覆盖端到端的完整数据流
- 示例：端到端CRC（覆盖整个传输过程的完整数据）

## 9. 算法类语法单元

### 9.1 DSL算法描述结构
支持算法类型的定义（crc16/crc32/custom/xor_sum等）
支持算法参数的配置（如多项式、初始值等）
支持数据范围的引用和计算

### 9.2 标准算法执行
内置标准算法执行器（如CRC-16）
支持参数化算法执行
确保算法执行的正确性

### 9.3 自定义算法
支持用户自定义算法逻辑
提供安全的算法执行环境
支持自定义逻辑的DSL描述

## 10. 多协议融合支持

### 10.1 CCSDS与CAN协议融合
- 支持CCSDS协议与CAN协议的混合使用
- 提供统一的语法单元接口，支持不同协议的语法单元
- 支持跨协议的数据转换和桥接功能

### 10.2 协议桥接示例
- 将CCSDS协议数据封装为CAN帧进行传输
- 在地面站或航天器上实现协议转换
- 支持不同协议间的时序同步

## 11. 语法单元设计原则

### 11.1 模块化设计
- 每个语法单元独立实现
- 明确的输入输出接口
- 便于测试和维护

### 11.2 标准化接口
- 统一的ProtocolUnit接口
- 支持打包/拆包/校验操作
- 保证单元间的互操作性

### 11.3 可扩展性
- 支持自定义语法单元
- 保留扩展字段和接口
- 兼容现有标准

## 12. 项目实现要点

### 12.1 Rust实现策略
- 利用Trait系统实现多态
- 使用所有权系统保证内存安全
- 通过模块化组织代码结构

### 12.2 DSL设计考虑
- 简洁易读的语法
- 支持层次化定义
- 允许参数化配置

### 12.3 组合策略
- 垂直组合：上下层协议封装
- 水平组合：同层协议复用
- 跨协议组合：不同协议间的桥接和转换
- 混合组合：复杂协议栈

## 13. 需求合理性验证

通过对CCSDS协议语法单元的深入研究，我们验证了项目需求的合理性：

1. **技术可行性**：协议结构清晰，适合模块化实现
2. **功能完整性**：覆盖航天通信主要协议层
3. **扩展性保障**：支持标准与自定义协议混合使用
4. **多协议支持**：支持CCSDS与CAN协议的混合使用
5. **帧结构深化**：支持帧数据区嵌套、序列管理、分路等功能
6. **DSL与JSON支持**：支持语法单元的DSL描述和协议的JSON格式描述
7. **Rust开发适配**：支持模块化接口设计和依赖库选择
8. **实用性**：满足实际航天任务需求

## 14. 下一步计划

1. 完善各语法单元的具体实现
2. 设计单元间组合的机制
3. 开发DSL解析器
4. 实现JSON协议描述解析器
5. 实现协议组装平台
6. 实现仿真验证功能
7. 构建测试用例库
8. 实现多协议桥接功能
9. 实现帧结构关键单元的深度功能

## 15. 关键决策记录

### 15.1 接口设计
决定使用Rust Trait作为语法单元的统一接口，保证类型安全和性能。

### 15.2 组合方式
采用协议栈方式管理语法单元组合，支持动态组装。

### 15.3 扩展机制
通过工厂模式支持自定义语法单元的注册和管理。

### 15.4 作用范围定义
明确定义每个语法单元的作用范围，支持层内局部、层内全量、跨层穿透、全链路全局四种范围。

### 15.5 多协议支持
设计统一的语法单元接口，支持不同协议栈的扩展和桥接。

### 15.6 帧结构深化
支持帧数据区嵌套、序列管理和分路功能，提供精细化的数据处理能力。

### 15.7 DSL与JSON支持
支持语法单元的DSL描述和协议的JSON格式描述，提供可直接落地的协议描述。

### 15.8 Rust开发适配
定义DSL引擎接口和协议组装平台接口，选择合适的依赖库。

这些研究结果为项目的后续开发奠定了坚实的理论基础，确保了项目方向的正确性。