# APDL（APDS协议定义语言）需求规格说明书

## 1. 文档概述

### 1.1 项目简介
APDL（APDS Protocol Definition Language）是一个面向航天领域的协议定义与仿真验证一体化平台，旨在提供CCSDS标准协议的灵活组合、全流程软件仿真和性能分析能力。

### 1.2 文档目的
本文档定义了APDL系统的需求规格，包括功能需求、性能需求、接口需求等，为系统设计和实现提供依据。

### 1.3 读者对象
- 系统架构师
- 软件开发人员
- 测试工程师
- 项目管理人员

## 2. 系统概述

### 2.1 系统目标
- 提供CCSDS协议的标准化定义工具
- 实现纯软件协议仿真验证平台
- 构建协议性能分析引擎
- 支持协议规范自动生成

### 2.2 核心价值
- 解决传统CCSDS协议开发中组合灵活度低的问题
- 消除仿真对硬件的依赖
- 降低协议扩展成本
- 提升协议验证的全面性

## 3. 功能需求

### 3.1 协议定义与扩展模块

#### 3.1.1 CCSDS标准协议库需求
- **FR-3.1.1.1**：系统应预实现CCSDS全系列标准协议的语法单元
- **FR-3.1.1.2**：系统应支持TM（遥测）、TC（遥控）、AOS（高级在轨系统）等标准协议层
- **FR-3.1.1.3**：系统应支持Space Packet协议的实现
- **FR-3.1.1.4**：每个标准协议单元应包含：层标识、帧/包格式定义、字段属性、复接/解复接规则

#### 3.1.2 自定义DSL需求
- **FR-3.1.2.1**：系统应提供轻量级声明式DSL，专为CCSDS协议组合设计
- **FR-3.1.2.2**：DSL应支持层定义、包含关系、字段自定义、扩展语法单元注册
- **FR-3.1.2.3**：DSL应支持CCSDS协议的任意组合/嵌套
- **FR-3.1.2.4**：DSL应支持可视化配置与代码双向同步

#### 3.1.3 语法单元扩展机制需求
- **FR-3.1.3.1**：系统应定义通用语法单元抽象接口（ProtocolUnit Trait）
- **FR-3.1.3.2**：所有标准/自定义语法单元必须实现该接口
- **FR-3.1.3.3**：系统应支持语法单元的热插拔/独立扩展
- **FR-3.1.3.4**：系统应提供语法单元库，支持注册、保存、复用

#### 3.1.4 语法单元详细需求

##### 3.1.4.1 帧结构基础单元需求
- **FR-3.1.4.1.1**：应实现帧同步序列字段（如固定值0xEB90）
- **FR-3.1.4.1.2**：应支持帧类型标识（数据帧/控制帧区分）
- **FR-3.1.4.1.3**：应支持帧长度字段（带+1计算逻辑）
- **FR-3.1.4.1.4**：应符合CCSDS 132.0-B-2标准

##### 3.1.4.2 信道与地址单元需求
- **FR-3.1.4.2.1**：应支持虚拟信道标识（6比特，范围0-63）
- **FR-3.1.4.2.2**：应支持目标地址字段（IPv6压缩格式）
- **FR-3.1.4.2.3**：应符合CCSDS 142.0-B-1标准

##### 3.1.4.3 数据完整性单元需求
- **FR-3.1.4.3.1**：应支持CRC-16校验算法（多项式0x1021）
- **FR-3.1.4.3.2**：应支持帧序号字段（8比特，递增循环）
- **FR-3.1.4.3.3**：应覆盖指定数据范围（帧控制→用户数据）

##### 3.1.4.4 数据控制单元需求
- **FR-3.1.4.4.1**：应支持分段标识（2比特，首段/中段/尾段/单段）
- **FR-3.1.4.4.2**：应支持数据长度指示字段
- **FR-3.1.4.4.3**：应支持子包重组逻辑

##### 3.1.4.5 用户自定义扩展单元需求
- **FR-3.1.4.5.1**：应支持用户自定义字段扩展
- **FR-3.1.4.5.2**：应兼容标准协议格式
- **FR-3.1.4.5.3**：应支持扩展字段的DSL描述

#### 3.1.5 语法单元作用范围分类需求

##### 3.1.5.1 层内局部单元需求
- **FR-3.1.5.1.1**：应支持单一层内的局部作用域
- **FR-3.1.5.1.2**：应支持作用范围的精确定义（如当前帧）
- **FR-3.1.5.1.3**：应支持层内字段间的依赖关系

##### 3.1.5.2 层内全量单元需求
- **FR-3.1.5.2.1**：应支持单一层内的全量数据作用域
- **FR-3.1.5.2.2**：应支持排除自身的计算（如CRC不包含自身）
- **FR-3.1.5.2.3**：应支持完整数据包的处理

##### 3.1.5.3 跨层穿透单元需求
- **FR-3.1.5.3.1**：应支持相邻层间的数据传递
- **FR-3.1.5.3.2**：应支持跨层数据范围的定义
- **FR-3.1.5.3.3**：应支持层间同步机制

##### 3.1.5.4 全链路全局单元需求
- **FR-3.1.5.4.1**：应支持端到端的全局作用域
- **FR-3.1.5.4.2**：应支持全局数据ID管理
- **FR-3.1.5.4.3**：应支持端到端校验机制

#### 3.1.6 帧结构关键单元需求（深化版）

##### 3.1.6.1 帧数据区嵌套单元需求
- **FR-3.1.6.1.1**：应支持主导头指针（定位首个子包）
- **FR-3.1.6.1.2**：应支持副导头指针（定位后续子包）
- **FR-3.1.6.1.3**：应实现子包数据区关联机制

##### 3.1.6.2 帧序列管理单元需求
- **FR-3.1.6.2.1**：应支持帧序列标志（区分帧角色）
- **FR-3.1.6.2.2**：应支持帧序列号（顺序追踪）
- **FR-3.1.6.2.3**：应实现丢帧检测和重复过滤机制

##### 3.1.6.3 分路单元需求
- **FR-3.1.6.3.1**：应支持基础分路标识（必选）
- **FR-3.1.6.3.2**：应支持扩展分路标识（可选）
- **FR-3.1.6.3.3**：应实现数据分发机制

#### 3.1.7 DSL规范与JSON协议描述需求

##### 3.1.7.1 语法单元DSL通用规范需求
- **FR-3.1.7.1.1**：应支持语法单元DSL的基础结构定义
- **FR-3.1.7.1.2**：应支持field、type、length、scope、cover等必选字段
- **FR-3.1.7.1.3**：应支持constraint、alg、associate、desc、role等可选字段
- **FR-3.1.7.1.4**：应支持多种数据类型（UintN、Bit(N)、RawData、Ip6Addr等）
- **FR-3.1.7.1.5**：应支持多种作用范围（layer、cross_layer、global等）
- **FR-3.1.7.1.6**：应支持数据覆盖范围的精确描述

##### 3.1.7.2 JSON协议描述需求
- **FR-3.1.7.2.1**：应支持CCSDS协议的JSON格式描述
- **FR-3.1.7.2.2**：应支持协议元数据定义（协议ID、名称、版本等）
- **FR-3.1.7.2.3**：应支持语法单元列表定义
- **FR-3.1.7.2.4**：应支持帧结构描述（帧头、数据区、帧尾）
- **FR-3.1.7.2.5**：应支持打包/拆包规范定义
- **FR-3.1.7.2.6**：应支持帧流嵌套结构描述

#### 3.1.8 Rust开发适配与模块接口需求

##### 3.1.8.1 DSL引擎接口需求
- **FR-3.1.8.1.1**：应支持DSL解析器接口定义（DslParser Trait）
- **FR-3.1.8.1.2**：应支持语法单元结构定义（SyntaxUnit）
- **FR-3.1.8.1.3**：应支持DSL解析和验证功能
- **FR-3.1.8.1.4**：应支持语法单元的字段定义（field_id、unit_type、length等）

##### 3.1.8.2 协议组装平台接口需求
- **FR-3.1.8.2.1**：应支持协议组装器接口定义（ProtocolAssembler Trait）
- **FR-3.1.8.2.2**：应支持协议层结构定义（ProtocolLayer）
- **FR-3.1.8.2.3**：应支持语法单元添加功能
- **FR-3.1.8.2.4**：应支持协议规范生成功能

##### 3.1.8.3 Rust依赖库选择需求
- **FR-3.1.8.3.1**：应支持DSL解析库（nom）
- **FR-3.1.8.3.2**：应支持多格式文档解析库（docx-rs、calamine、pdf-rs）
- **FR-3.1.8.3.3**：应支持CRC计算库（crc）
- **FR-3.1.8.3.4**：应支持异步链路仿真库（tokio、bytes）
- **FR-3.1.8.3.5**：应支持自定义脚本执行库（rhai）
- **FR-3.1.8.3.6**：应支持错误处理库（anyhow、thiserror）

#### 3.1.9 算法类语法单元需求

##### 3.1.9.1 DSL算法描述需求
- **FR-3.1.9.1.1**：应支持算法类型的定义（crc16/crc32/custom/xor_sum等）
- **FR-3.1.9.1.2**：应支持算法参数的配置（如多项式、初始值等）
- **FR-3.1.9.1.3**：应支持数据范围的引用和计算

##### 3.1.9.2 标准算法执行需求
- **FR-3.1.9.2.1**：应内置标准算法执行器（如CRC-16）
- **FR-3.1.9.2.2**：应支持参数化算法执行
- **FR-3.1.9.2.3**：应确保算法执行的正确性

##### 3.1.9.3 自定义算法需求
- **FR-3.1.9.3.1**：应支持用户自定义算法逻辑
- **FR-3.1.9.3.2**：应提供安全的算法执行环境
- **FR-3.1.9.3.3**：应支持自定义逻辑的DSL描述

#### 3.1.10 CAN总线协议语法单元扩展需求

##### 3.1.10.1 总线仲裁类单元需求
- **FR-3.1.10.1.1**：应支持CAN仲裁场单元（11/29位ID，RTR位标识数据帧/远程帧）
- **FR-3.1.10.1.2**：应支持仲裁退避单元（仲裁失败后等待总线空闲并重新发送）
- **FR-3.1.10.1.3**：应实现显性优先机制（显性电平优先传输）

##### 3.1.10.2 帧控制与错误处理类单元需求
- **FR-3.1.10.2.1**：应支持DLC字段单元（4比特，0~15，支持传统CAN和CAN FD）
- **FR-3.1.10.2.2**：应支持位填充单元（连续5相同位插入相反位）
- **FR-3.1.10.2.3**：应支持ACK应答单元（接收端确认机制）

#### 3.1.11 多协议融合支持需求
- **FR-3.1.11.1**：应支持CCSDS与CAN协议的混合使用
- **FR-3.1.11.2**：应提供统一的语法单元接口，支持不同协议的语法单元
- **FR-3.1.11.3**：应支持跨协议的数据转换和桥接功能

### 3.2 文档解析与预处理模块

#### 3.2.1 多格式解析需求
- **FR-3.2.1.1**：系统应支持Word、Excel、PDF、表格等多种文档格式
- **FR-3.2.1.2**：系统应集成Rust生态成熟的解析库
- **FR-3.2.1.3**：系统应支持宽松输入适配
- **FR-3.2.1.4**：系统应实现元数据标准化

#### 3.2.2 信息提取需求
- **FR-3.2.2.1**：系统应基于规则引擎+浅度NLP提取核心信息
- **FR-3.2.2.2**：系统应支持协议层名、包含关系、字段定义的提取
- **FR-3.2.2.3**：系统应支持参数约束的识别
- **FR-3.2.2.4**：系统应提供可视化纠错提示

### 3.3 协议规范生成模块

#### 3.3.1 模板引擎需求
- **FR-3.3.1.1**：系统应内置航天领域协议规范标准模板
- **FR-3.3.1.2**：系统应支持模板自定义
- **FR-3.3.1.3**：系统应支持自动填充生成
- **FR-3.3.1.4**：系统应生成结构化的协议规范

#### 3.3.2 导出功能需求
- **FR-3.3.2.1**：系统应支持Word（docx）格式导出
- **FR-3.3.2.2**：系统应支持PDF格式导出
- **FR-3.3.2.3**：系统应支持Excel格式导出
- **FR-3.3.2.4**：系统应支持Markdown格式导出

### 3.4 纯软件仿真内核模块

#### 3.4.1 数据模拟生成需求
- **FR-3.4.1.1**：系统应支持规则化数据生成
- **FR-3.4.1.2**：系统应支持自定义数据导入
- **FR-3.4.1.3**：系统应生成符合参数约束的测试数据
- **FR-3.4.1.4**：系统应支持实际业务数据封装

#### 3.4.2 打包/复接引擎需求
- **FR-3.4.2.1**：系统应实现分层递阶打包
- **FR-3.4.2.2**：系统应支持多路PDU的软件复接
- **FR-3.4.2.3**：系统应支持时分复接、统计复接、空分复接
- **FR-3.4.2.4**：系统应与具体语法单元解耦

#### 3.4.3 传输链路模拟需求
- **FR-3.4.3.1**：系统应支持无差错点到点传输
- **FR-3.4.3.2**：系统应支持误码率、丢包率、时延配置
- **FR-3.4.3.3**：系统应支持单播、广播模式
- **FR-3.4.3.4**：系统应支持多发送端/多接收端模拟

#### 3.4.4 接收/解复接/拆包引擎需求
- **FR-3.4.4.1**：系统应实现接收缓冲区
- **FR-3.4.4.2**：系统应支持按同步字识别和帧定界
- **FR-3.4.4.3**：系统应实现解复接功能
- **FR-3.4.4.4**：系统应实现分层拆包
- **FR-3.4.4.5**：系统应实现差错处理机制

### 3.5 协议检验与性能分析模块

#### 3.5.1 协议合理性检验需求
- **FR-3.5.1.1**：系统应检验各层帧/包格式合法性
- **FR-3.5.1.2**：系统应检验打包/拆包正确性
- **FR-3.5.1.3**：系统应检验复接/解复接正确性
- **FR-3.5.1.4**：系统应检验异常处理有效性
- **FR-3.5.1.5**：系统应检验语法单元兼容性

#### 3.5.2 性能统计需求
- **FR-3.5.2.1**：系统应统计各层打包/拆包耗时
- **FR-3.5.2.2**：系统应统计吞吐量（FPS、PPS）
- **FR-3.5.2.3**：系统应统计链路利用率和有效数据率
- **FR-3.5.2.4**：系统应统计端到端时延
- **FR-3.5.2.5**：系统应统计异常场景性能

#### 3.5.3 可视化分析需求
- **FR-3.5.3.1**：系统应实现实时性能指标展示
- **FR-3.5.3.2**：系统应支持多维度对比分析
- **FR-3.5.3.3**：系统应生成量化性能检验报告
- **FR-3.5.3.4**：系统应支持报告导出

### 3.6 交互模块需求

#### 3.6.1 GUI界面需求
- **FR-3.6.1.1**：系统应提供基于egui/tauri的跨平台GUI
- **FR-3.6.1.2**：系统应集成所有模块功能
- **FR-3.6.1.3**：系统应支持拖拽式协议配置
- **FR-3.6.1.4**：系统应支持实时仿真状态显示

#### 3.6.2 CLI接口需求
- **FR-3.6.2.1**：系统应支持命令行批量执行
- **FR-3.6.2.2**：系统应支持参数化输入
- **FR-3.6.2.3**：系统应支持脚本调用
- **FR-3.6.2.4**：系统应支持批处理模式

#### 3.6.3 API接口需求
- **FR-3.6.3.1**：系统应提供RESTful API
- **FR-3.6.3.2**：系统应提供gRPC API
- **FR-3.6.3.3**：系统应支持协议定义、仿真、分析能力集成
- **FR-3.6.3.4**：系统应支持异步操作

## 4. 非功能性需求

### 4.1 性能需求
- **NFR-4.1.1**：系统应支持大规模数据仿真（>100万帧/秒）
- **NFR-4.1.2**：系统应保证长时间运行稳定性（>24小时）
- **NFR-4.1.3**：系统应实现低延迟响应（<100ms）

### 4.2 可靠性需求
- **NFR-4.2.1**：系统应保证内存安全，无内存泄漏
- **NFR-4.2.2**：系统应实现错误恢复机制
- **NFR-4.2.3**：系统应支持断点续仿

### 4.3 可扩展性需求
- **NFR-4.3.1**：系统应支持模块化扩展
- **NFR-4.3.2**：系统应支持协议单元热插拔
- **NFR-4.3.3**：系统应支持插件化开发

### 4.4 可移植性需求
- **NFR-4.4.1**：系统应支持Windows、Linux、macOS平台
- **NFR-4.4.2**：系统应使用跨平台技术栈

## 5. 接口需求

### 5.1 用户接口
- 基于egui/tauri的图形用户界面
- 命令行界面
- Web API接口

### 5.2 硬件接口
- 无直接硬件依赖（纯软件仿真）

### 5.3 软件接口
- 支持与外部工具的数据交换
- 支持标准文档格式导入导出

## 6. 约束条件

### 6.1 设计约束
- 必须使用Rust语言开发
- 必须实现模块解耦架构
- 必须支持平台-语法单元分离

### 6.2 实现约束
- 必须遵循CCSDS标准
- 必须保证代码质量
- 必须提供充分测试

### 6.3 接口约束
- 必须提供标准化API
- 必须支持主流文档格式

## 7. 质量属性

### 7.1 可维护性
- 模块化设计
- 清晰的接口定义
- 完整的文档

### 7.2 可用性
- 直观的用户界面
- 详细的帮助文档
- 错误提示友好

### 7.3 安全性
- 内存安全（Rust保证）
- 数据隔离
- 访问控制

## 8. 验收标准

### 8.1 功能验收
- 所有功能需求均已实现
- CCSDS协议单元正确实现
- 仿真功能正常工作

### 8.2 性能验收
- 满足性能需求指标
- 稳定性测试通过
- 压力测试通过

### 8.3 用户验收
- 用户界面友好
- 操作流程顺畅
- 文档完整准确